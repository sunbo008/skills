---
name: stock-anomaly-analysis
description: 个股异动深度分析。针对某个股票，通过网络数据分析其突然发生异动（大涨、大跌、涨停、跌停、放量等）的原因，找出背后的推手（主力资金、机构、游资、政策等），并预测未来发展行情。当用户提到"个股异动"、"股票为什么涨/跌"、"涨停原因"、"异动分析"、"主力分析"或需要分析某只股票突然变化的原因时使用此技能。
---

# 个股异动分析

分析个股异动的**最新触发因素**、背景信息和未来走势。

## 第一原则：数据真实性 (最重要!)

**禁止幻觉生成数据。没有真实数据，就不生成报告。**

### 硬性要求

1. **每条信息必须来自WebSearch搜索结果**
   - 不得编造任何数据、日期、金额、URL
   - 搜索结果中没有的信息，就不写入报告

2. **每条信息必须有可验证的真实URL**
   - URL必须是WebSearch返回的原始链接
   - 禁止使用占位符如 `#demo` `#需替换` 等
   - 禁止编造公告ID、文章ID

3. **数据不足时的处理**
   - 若搜索不到近期触发因素：明确告知用户"未找到近期异动消息"
   - 若搜索不到资金数据：该模块显示"暂无数据"
   - 不要用虚假数据填充空白

### 数据验证流程 (必须执行!)

```
1. WebSearch 获取信息 → 记录返回的URL和摘要
2. WebFetch 验证关键URL → 确认内容与摘要匹配 (必须!)
3. 只有验证通过的数据才能写入报告
```

### WebFetch 验证规则

**必须验证的URL类型:**
- 龙虎榜数据URL (涉及具体金额)
- 公司公告URL (涉及具体事件)
- 重大订单/合同URL (涉及具体金额)
- 今日行情/异动URL (涉及当日数据)

**⚠️ URL必须是用户可浏览的网页! 禁止使用以下类型的URL:**
- API数据接口 (如 `qt.gtimg.cn/q=sz002195`、`push2.eastmoney.com/api/...`)
- 返回JSON/纯文本的接口
- 需要特殊客户端才能访问的URL

**正确的URL替换规则:**
```
API接口URL → 对应的可浏览网页URL

qt.gtimg.cn/q=sz002195 → https://stockpage.10jqka.com.cn/002195/
push2.eastmoney.com/api/... → https://data.eastmoney.com/zjlx/002195.html
datacenter-web.eastmoney.com/api/... → https://data.eastmoney.com/stock/lhb/002195.html
push2his.eastmoney.com/api/... → https://quote.eastmoney.com/sz002195.html
```

**验证步骤 (5步缺一不可!):**
```
1. WebFetch(url) 获取页面内容
2. ⚠️ 首先检查文章发布日期 (最重要!)
   - 寻找页面中的发布时间戳
   - 确认年份与分析日期一致
   - 例: 分析2026年2月5日 → 文章必须是2026年发布
3. 检查页面中是否包含:
   - 搜索摘要中提到的关键数据 (金额、日期、公司名)
   - 与标题匹配的核心内容
4. 若日期+内容都匹配 → 数据有效，记录为 verified: true
5. 若日期不匹配或内容不匹配 → 丢弃该数据，不写入报告
```

**⚠️ 年份验证是第一优先级!**

搜索"2月5日龙虎榜"可能返回去年同日的文章，必须核对发布年份！

**验证示例 (正确):**
```
分析日期: 2026年2月5日
WebSearch返回: "岩山科技龙虎榜，机构净买入7059万"
URL: https://finance.ifeng.com/c/xxx

WebFetch验证:
1. 页面发布时间: "2026年02月05日 16:41" ✓ (年份匹配!)
2. 页面包含"岩山科技" ✓
3. 页面包含"7059" ✓
4. 页面包含"机构" ✓
→ 验证通过，数据可用
```

**验证示例 (失败 - 年份错误):**
```
分析日期: 2026年2月5日
WebSearch返回: "岩山科技龙虎榜，机构净买入7059万"
URL: https://finance.ifeng.com/c/xxx

WebFetch验证:
1. 页面发布时间: "2025年02月05日 16:41" ✗ (年份不匹配!)
→ 验证失败! 这是去年的数据，必须丢弃!
```

**验证示例 (失败 - 404/内容不匹配):**
```
若WebFetch显示"404"或内容不匹配:
→ 验证失败，丢弃该条数据
```

**JSON中标记验证状态:**
```json
{
  "title": "机构净买入7059万",
  "url": "https://...",
  "verified": true,
  "verify_note": "WebFetch确认页面包含关键数据"
}
```

## 数据结构

**异动分析 = 近期触发 + 历史背景**

- **triggers (近期触发)**: 最近1-3天的新消息，必须有真实URL
- **background (历史背景)**: 近几个月的重要事件，必须有真实URL

## 工作流程

### 第一步: 获取实时行情 (优先使用API!)

**优先方案: 使用数据接口脚本获取精确数据**

```bash
# 获取实时行情 (腾讯财经接口)
python scripts/fetch_stock_data.py 002195 --realtime

# 获取完整数据 (行情+资金流向+龙虎榜+K线)
python scripts/fetch_stock_data.py 002195
```

**接口数据来源:**
- 实时行情: 腾讯财经 (qt.gtimg.cn)
- 资金流向: 东方财富 (push2.eastmoney.com)
- 龙虎榜: 东方财富 (datacenter-web.eastmoney.com)
- K线数据: 东方财富 (push2his.eastmoney.com)

**备选方案: WebSearch搜索 (仅当API不可用时)**
```
搜索词: "[股票名称] [代码] 今日行情 [完整年月日]"
```

**必须确认:**
- 当前价格、涨跌幅 (必须标注时间)
- 今日成交量/成交额
- 今日最高/最低
- 换手率

### 第二步: 搜索近期触发因素 (重点!)

**⚠️ 搜索词必须包含完整年份!**

```
搜索词模板 (必须包含4位年份):
1. "[股票名称] [完整年月日如2026年2月5日]"
2. "[股票名称] 龙虎榜 [完整年月日]"
3. "[股票名称] 最新消息 [完整年月日]"
4. "[股票名称] 公告 [完整年月]"
5. "[所属板块] 异动 [完整年月日]"

错误示例: "岩山科技 2月5日" ← 可能返回去年数据!
正确示例: "岩山科技 2026年2月5日" ← 明确年份
```

**搜索后必须WebFetch验证 (含日期核验!):**
```
对于每个关键URL，执行:
1. WebFetch(url) 获取页面内容
2. 首先检查文章发布年份是否与分析日期一致!
3. 再检查内容是否包含搜索摘要中的关键信息
```

**近期触发因素类型:**
- 今日/昨日公司公告
- 今日龙虎榜数据
- 今日主力资金流向
- 近日行业政策/消息
- 板块联动效应
- 市场情绪/热点轮动

**时效性标准:**
- ⭐ 今日消息: 最相关
- ⭐ 近3日消息: 高度相关
- 近7日消息: 相关
- 超过7日: 归入背景信息

### 第三步: 搜索历史背景

**搜索近几个月的重要事件:**
```
搜索词: "[股票名称] 重大事件 [年份]"
```

**背景信息包括:**
- 重大合同/订单
- 业绩情况
- 战略合作
- 股权变动
- 行业地位

### 第四步: 分析推手

**今日资金动向:**
- 主力净流入/流出
- 北向资金变化
- 大单成交情况

**龙虎榜 (若有):**
- 上榜原因
- 买卖席位
- 机构/游资动向

### 第五步: 预测走势

基于最新触发因素判断:
- 短期 (1-5日): 支撑位、压力位
- 中期 (1-3月): 趋势判断
- 风险提示

### 第六步: 生成报告

**JSON数据结构:**

```json
{
  "stock": {
    "code": "002195",
    "name": "岩山科技",
    "sector": "AI+机器人",
    "price": 9.93,
    "price_time": "2026-02-05 15:00",
    "change_pct": 3.45,
    "volume": "8.5亿",
    "turnover": "12.3%",
    "high": 10.15,
    "low": 9.50,
    "anomaly_type": "大涨"
  },
  "analysis_date": "2026-02-05",
  
  "triggers": [
    {
      "type": "消息面",
      "title": "公司发布重大合同公告",
      "detail": "...",
      "date": "2026-02-05",
      "source": "巨潮资讯",
      "url": "http://www.cninfo.com.cn/new/disclosure/detail?stockCode=002195&announcementId=xxx",
      "verified": true,
      "verify_note": "WebFetch确认页面包含公告内容",
      "impact": "positive",
      "freshness": "today",
      "weight": 40
    }
  ],
  
  "background": [
    {
      "title": "宇树科技2亿元AI订单",
      "detail": "2025年9月获得宇树科技2亿元订单...",
      "date": "2025-09-01",
      "source": "东方财富",
      "url": "https://caifuhao.eastmoney.com/news/20250918123725099612100",
      "verified": true,
      "verify_note": "WebFetch确认页面包含2亿元订单信息"
    }
  ],
  
  "fund_flow": {
    "main_net": "+2.3亿",
    "north_net": "+0.5亿",
    "big_order": "+1.8亿",
    "date": "2026-02-05"
  },
  
  "dragon_tiger": {
    "date": "2026-02-04",
    "reason": "涨幅偏离7%",
    "buy_seats": ["机构专用", "东方财富拉萨"],
    "sell_seats": ["华泰深圳益田路"]
  },
  
  "outlook": {
    "short_term": "...",
    "mid_term": "...",
    "risks": ["..."]
  },
  
  "sources": [...]
}
```

**URL格式示例:**
- 巨潮公告: `http://www.cninfo.com.cn/new/disclosure/detail?stockCode=002195&announcementId=xxx`
- 东方财富: `https://caifuhao.eastmoney.com/news/具体文章ID`
- 同花顺: `https://stock.10jqka.com.cn/具体路径`
- 雪球: `https://xueqiu.com/具体文章ID`

**freshness字段说明:**
- `today`: 今日消息
- `recent`: 近3日
- `week`: 近7日
- `old`: 超过7日(应放入background)

运行脚本:
```bash
# 只接受真实数据文件，禁止使用示例数据
python scripts/generate_report.py --data analysis.json --output 报告.html
```

**禁止使用 --sample 参数生成报告。示例数据仅供了解JSON格式，不得用于实际报告。**

## 报告结构

1. **股票卡片**: 实时行情数据
2. **近期触发因素**: 最新消息(按时间倒序，突出今日消息)
3. **资金动向**: 今日资金流向、龙虎榜
4. **历史背景**: 近期重要事件(作为背景介绍)
5. **走势预判**: 短期/中期展望
6. **信息来源**: 完整来源列表

## 完整工作流程示例

用户: "岩山科技今天为什么涨停"

```
=== 第一轮: WebSearch搜索 ===

1. WebSearch "岩山科技 龙虎榜 2026年2月5日"
   → 返回: https://finance.ifeng.com/c/xxx "机构净买入7059万"

2. WebSearch "人形机器人 板块 今日"  
   → 返回: https://www.stcn.com/article/xxx "板块大涨3.28%"

=== 第二轮: WebFetch验证 (必须!) ===

3. WebFetch "https://finance.ifeng.com/c/xxx"
   → 检查页面内容:
   - 包含"岩山科技" ✓
   - 包含"7059" ✓
   - 包含"机构净买入" ✓
   → 验证通过 ✓

4. WebFetch "https://www.stcn.com/article/xxx"
   → 检查页面内容:
   - 包含"人形机器人" ✓
   - 包含"3.28%" ✓
   → 验证通过 ✓

=== 第三轮: WebSearch背景信息 ===

5. WebSearch "岩山科技 智能驾驶 订单"
   → 返回多个URL

6. WebFetch验证关键URL...

=== 最终: 只使用验证通过的数据生成报告 ===
```

## 注意事项

- **⚠️ 年份验证是第一优先级**: WebFetch验证时，必须首先核对文章发布年份。搜索"2月5日"可能返回去年同日数据，必须核验年份一致!
- **WebFetch验证必须执行**: 关键数据URL必须经过WebFetch验证，确认日期+内容都匹配
- **搜索词必须包含完整年份**: 使用"2026年2月5日"而非"2月5日"
- **时效性优先**: 异动分析必须以最新消息为主
- **区分触发与背景**: 旧消息是背景，不是触发因素
- **来源可追溯**: 每条信息必须有日期和URL，且经过验证
- **验证失败即丢弃**: 若年份不匹配、404、或内容不匹配，该数据不得写入报告
- **数据不足坦诚告知**: 若找不到当日数据，明确告知用户，不要用旧数据冒充
- **免责声明**: 所有分析仅供参考，不构成投资建议

## scripts/

- `fetch_stock_data.py`: **数据获取脚本 (推荐优先使用!)**
  - 从腾讯财经、东方财富API获取实时精确数据
  - 支持: 实时行情、资金流向、龙虎榜、K线
  - 用法: `python scripts/fetch_stock_data.py 002195`
  
- `generate_report.py`: 报告生成脚本，区分触发因素和背景信息

## 数据获取优先级

1. **API接口 (最可靠)**: `fetch_stock_data.py` 直接从腾讯/东方财富获取
2. **WebSearch (辅助)**: 用于获取新闻、公告等文本信息
3. **WebFetch (验证)**: 验证URL内容真实性
